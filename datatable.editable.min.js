if(window.DataTable&&typeof window.DataTable==="function"){DataTable.extend("editable",function(options,utils){var instance=this;var defaults={classes:{row:"datatable-editor-row",form:"datatable-editor-form",item:"datatable-editor-item",menu:"datatable-editor-menu",save:"datatable-editor-save",block:"datatable-editor-block",close:"datatable-editor-close",inner:"datatable-editor-inner",input:"datatable-editor-input",label:"datatable-editor-label",modal:"datatable-editor-modal",action:"datatable-editor-action",header:"datatable-editor-header",wrapper:"datatable-editor-wrapper",container:"datatable-editor-container",separator:"datatable-editor-separator"},hiddenColumns:false,contextMenu:true,menuItems:[{text:"<span class='mdi mdi-lead-pencil'></span> Edit Cell",action:function(e){this.editCell()}},{text:"<span class='mdi mdi-lead-pencil'></span> Edit Row",action:function(e){this.editRow()}},{separator:true},{text:"<span class='mdi mdi-delete'></span> Remove Row",action:function(e){if(confirm("Are you sure?")){this.removeRow()}}}]};var on=function(el,e,fn){el.addEventListener(e,fn,false)};var off=function(el,e,fn){el.removeEventListener(e,fn)};var closest=function(el,fn){return el&&el!==document.body&&(fn(el)?el:closest(el.parentNode,fn))};var debounce=function(n,t,u){var e;return function(){var i=this,o=arguments,a=u&&!e;clearTimeout(e),e=setTimeout(function(){e=null,u||n.apply(i,o)},t),a&&n.apply(i,o)}};var Editor=function(target,config){this.target=target;this.config=utils.extend(defaults,config)};Editor.prototype.init=function(){var that=this,o=that.config;utils.classList.add(instance.wrapper,"datatable-editable");if(o.contextMenu){that.container=utils.createElement("div",{id:o.classes.container});that.wrapper=utils.createElement("div",{class:o.classes.wrapper});that.menu=utils.createElement("ul",{class:o.classes.menu});if(o.menuItems&&o.menuItems.length){o.menuItems.forEach(function(item){var li=utils.createElement("li",{class:item.separator?o.classes.separator:o.classes.item});if(!item.separator){var a=utils.createElement("a",{class:o.classes.action,href:item.url||"#",html:item.text});li.appendChild(a);if(item.action&&typeof item.action==="function"){on(a,"click",function(e){e.preventDefault();item.action.call(that,e)})}}that.menu.appendChild(li)})}that.wrapper.appendChild(that.menu);that.container.appendChild(that.wrapper);that.update()}that.data={};that.closed=true;that.editing=false;that.editingRow=false;that.editingCell=false;that.bindEvents();setTimeout(function(){instance.emit("editable.init")},10)};Editor.prototype.bindEvents=function(){var that=this;this.events={context:this.context.bind(this),update:this.update.bind(this),dismiss:this.dismiss.bind(this),keydown:this.keydown.bind(this),double:this.double.bind(this)};on(this.target,"dblclick",this.events.double);on(document,"click",this.events.dismiss);on(document,"keydown",this.events.keydown);if(this.config.contextMenu){on(this.target,"contextmenu",this.events.context);this.events.reset=debounce(this.events.update,50);on(window,"resize",this.events.reset);on(window,"scroll",this.events.reset)}};Editor.prototype.context=function(e){this.event=e;var valid=this.target.contains(e.target);if(!this.disabled&&valid){e.preventDefault();var x=e.pageX;var y=e.pageY;if(x>this.limits.x){x-=this.rect.width}if(y>this.limits.y){y-=this.rect.height}this.wrapper.style.top=y+"px";this.wrapper.style.left=x+"px";this.openMenu();this.update()}};Editor.prototype.double=function(e){if(!this.editing){var cell=closest(e.target,function(el){return el.nodeName==="TD"});if(cell){this.editCell(cell);e.preventDefault()}}};Editor.prototype.keydown=function(e){if(this.editing&&this.data){if(e.keyCode===13){if(this.editingCell){this.saveCell()}else if(this.editingRow){this.saveRow()}}else if(e.keyCode===27){this.saveCell(this.data.content)}}};Editor.prototype.editCell=function(cell){cell=cell||closest(this.event.target,function(el){return el.nodeName==="TD"});if(cell.nodeName!=="TD"||this.editing)return;var that=this;that.data={cell:cell,content:cell.innerHTML,input:utils.createElement("input",{type:"text",class:that.config.classes.input,value:cell.innerHTML})};cell.innerHTML="";cell.appendChild(that.data.input);setTimeout(function(){that.data.input.focus();that.data.input.selectionStart=that.data.input.selectionEnd=that.data.input.value.length;that.editing=true;that.editingCell=true;that.closeMenu()},10)};Editor.prototype.saveCell=function(value,cell){cell=cell||this.data.cell;value=value||this.data.input.value;var oldData=cell.data;cell.innerHTML=value.trim();this.data={};this.editing=this.editingCell=false;instance.emit("editable.save.cell",value,oldData,cell)};Editor.prototype.editRow=function(row){row=row||closest(this.event.target,function(el){return el.nodeName==="TR"});if(row.nodeName!=="TR"||this.editing)return;var that=this,o=that.config;row=o.hiddenColumns?instance.data[row.dataIndex]:instance.activeRows[row.dataIndex];var template=["<div class='"+o.classes.inner+"'>","<div class='"+o.classes.header+"'>","<h4>Editing row</h4>","<button class='"+o.classes.close+"' type='button' data-editor-close>Ã—</button>"," </div>","<div class='"+o.classes.block+"'>","<form class='"+o.classes.form+"'>","<div class='"+o.classes.row+"'>","<button class='"+o.classes.save+"' type='button' data-editor-save>Save</button>","</div>","</form>","</div>","</div>"].join("");var modal=utils.createElement("div",{class:o.classes.modal,html:template});var inner=modal.firstElementChild;var form=inner.lastElementChild.firstElementChild;[].slice.call(row.cells).forEach(function(cell,i){form.insertBefore(utils.createElement("div",{class:o.classes.row,html:["<div class='datatable-editor-row'>","<label class='"+o.classes.label+"'>"+instance.labels[o.hiddenColumns?i:instance.activeHeadings[i].originalCellIndex]+"</label>","<input class='"+o.classes.input+"' value='"+cell.innerHTML+"' type='text'>","</div>"].join("")}),form.lastElementChild)});this.modal=modal;this.openModal();var inputs=[].slice.call(form.elements);inputs.pop();that.data={row:row,inputs:inputs};this.editing=true;this.editingRow=true;modal.addEventListener("click",function(e){var node=e.target;if(node.hasAttribute("data-editor-close")){that.closeModal()}else if(node.hasAttribute("data-editor-save")){that.saveRow()}});that.closeMenu()};Editor.prototype.saveRow=function(data,row){var that=this,o=that.config;data=data||that.data.inputs.map(function(input){return input.value.trim()});row=row||that.data.row;var oldData=[].slice.call(row.cells).map(function(cell){return cell.data});[].slice.call(row.cells).forEach(function(cell,i){cell=instance.data[row.dataIndex].cells[o.hiddenColumns?i:instance.activeHeadings[i].originalCellIndex];cell.innerHTML=cell.data=data[i]});instance.columns().rebuild();this.closeModal();instance.emit("editable.save.row",data,oldData,row)};Editor.prototype.openModal=function(){if(!this.editing&&this.modal){document.body.appendChild(this.modal)}};Editor.prototype.closeModal=function(){if(this.editing&&this.modal){document.body.removeChild(this.modal);this.modal=this.editing=this.editingRow=false}};Editor.prototype.removeRow=function(row){if(!row){var row=closest(this.event.target,function(node){return node.nodeName==="TR"});if(row&&row.dataIndex!==undefined){instance.rows().remove(row.dataIndex);this.closeMenu()}}else{if(row instanceof Element&&row.nodeName==="TR"&&row.dataIndex!==undefined){row=row.dataIndex}instance.rows().remove(row);this.closeMenu()}};Editor.prototype.update=function(){var scrollX=window.scrollX||window.pageXOffset;var scrollY=window.scrollY||window.pageYOffset;this.rect=this.wrapper.getBoundingClientRect();this.limits={x:window.innerWidth+scrollX-this.rect.width,y:window.innerHeight+scrollY-this.rect.height}};Editor.prototype.dismiss=function(e){var valid=true;if(this.config.contextMenu){valid=!this.wrapper.contains(e.target);if(this.editing){valid=!this.wrapper.contains(e.target)&&e.target!==this.data.input}}if(valid){if(this.editing){this.saveCell(this.data.content)}this.closeMenu()}};Editor.prototype.openMenu=function(){if(this.config.contextMenu){document.body.appendChild(this.container);this.closed=false;instance.emit("editable.context.open")}};Editor.prototype.closeMenu=function(){if(this.config.contextMenu&&!this.closed){this.closed=true;document.body.removeChild(this.container);instance.emit("editable.context.close")}};Editor.prototype.destroy=function(){off(this.target,"dblclick",this.events.double);off(this.target,"contextmenu",this.events.context);off(document,"click",this.events.dismiss);off(document,"keydown",this.events.keydown);off(window,"resize",this.events.reset);off(window,"scroll",this.events.reset);document.body.removeChild(this.container)};return new Editor(this.body,options)})}
